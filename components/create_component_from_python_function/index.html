<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://cloud-pipelines.net/components/create_component_from_python_function/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Create a component from a Python function - Cloud Pipelines</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Cloud Pipelines</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Pipeline Editor</a>
                            </li>
                            <li class="navitem">
                                <a href="../../privacy_policy/" class="nav-link">Privacy policy</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Components <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="./" class="dropdown-item active">Create a component from a Python function</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../../privacy_policy/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" class="nav-link disabled">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#create-a-component-from-a-python-function" class="nav-link">Create a component from a Python function</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#what-is-a-pipeline-component" class="nav-link">What is a pipeline component?</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#creating-a-component-from-a-python-function" class="nav-link">Creating a component from a Python function</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="create-a-component-from-a-python-function">Create a component from a Python function</h1>
<h2 id="what-is-a-pipeline-component">What is a pipeline component?</h2>
<p>A pipeline consists of component tasks connected together in a graph.</p>
<p>Components have inputs and outputs.
Component reads the input data, processes it and outputs the results.
Output of one component can be passed to another component's input.
That's how components are connected together to form a pipeline.</p>
<p>Each component has an interface (input and output definitions), an implementation (usually a containerized command-line program) and metadata (component name, description and other optional properties).</p>
<p>The components are saved in ComponentSpec format files (<code>component.yaml</code>) that can be shared anywhere on the Internet.
When building a pipeline, several components can be loaded from <code>component.yaml</code> files and connected together to form a pipeline.</p>
<p>Container components are based on containerized command-line programs.
But that does not mean that creating a component always involves building new container images or writing command-line programs.
There is a way to automatically generate a component from a Python function without a need to build any container images.</p>
<h2 id="creating-a-component-from-a-python-function">Creating a component from a Python function</h2>
<p>Creating a component from a Python function is very easy (1 line of code).
(However the function needs to follow several simple rules.)
<em>Do not forget to install the <a href="https://pypi.org/project/cloud-pipelines/">Cloud Pipelines SDK</a>:</em> <code>pip install cloud-pipelines</code>.</p>
<h3 id="simple-example">Simple example</h3>
<p>Let's start with an example.
This is a simple python function:</p>
<pre><code class="language-python">def add(a: int, b: int) -&gt; int:
    return a + b
</code></pre>
<p>It's a normal Python function.
There is nothing in this function that is specific to Cloud Pipelines.
However this function can be converted to a pipeline component using the <code>pipelines.components.create_component_from_func</code> function from the <a href="https://pypi.org/project/cloud-pipelines/">Cloud Pipelines SDK</a>:</p>
<!-- TODO: Add link to the SDK documentation. -->

<pre><code class="language-python">from pipelines.components import create_component_from_func

add_op = create_component_from_func(
    func=add,
    output_component_file=&quot;component.yaml&quot;,
)
</code></pre>
<h3 id="reading-and-writing-files">Reading and writing files.</h3>
<p>Let's look at a more complex example.
This function filters a text file by searching for a certain string pattern and returns only the matching lines.</p>
<pre><code class="language-python">def filter_text(
    text_path: InputPath(),
    filtered_text_path: OutputPath(),
    pattern: str,
):
    import re
    with open(text_path, 'r') as reader:
        with open(filtered_text_path, 'w') as writer:
            for line in reader:
                if re.search(pattern, line):
                    writer.write(line)

# Creating a component
filter_text_op = create_component_from_func(
    func=filter_text,
    output_component_file=&quot;component.yaml&quot;,
)
</code></pre>
<p>This function reads the data from a file (<code>text_path</code>) and writes the data to a file (<code>filtered_text_path</code>).
Such path parameters need to be annotated using the <code>InputPath()</code> and <code>OutputPath()</code> annotations.
Also note that the <code>import</code> statement is placed inside the function.
This is needed so that the component function is self-contained.</p>
<h3 id="the-inputpath-and-outputpath-annotations">The <code>InputPath</code> and <code>OutputPath</code> annotations</h3>
<p>The <code>text_path: InputPath()</code> annotation tells the system that the input data for the <code>text</code> input should be placed into some file and the path of that file should be given to the function as a value for the <code>text_path</code> function parameter.</p>
<p>The <code>filtered_text_path: OutputPath()</code> annotation tells the system that it should generate and give the function a path (via the <code>filtered_text_path</code> parameter) where the function should write the output data.
After the function finishes the execution, the system will take the output data written by the function, put it into storage and make it available for passing to other components.</p>
<h4 id="why-do-we-need-the-inputpath-parameter-annotation">Why do we need the <code>InputPath</code> parameter annotation?</h4>
<p>Not all data can be passed/received as a simple string.
Examples: binary data, large data, directories.
In all these cases, the code should read data from a file or directory pointed to by a path.
This is why we have a <code>text_path: InputPath()</code> parameter and not <code>text: str</code> parameter (although the latter could still work for short texts).
Another reason why the <code>InputPath</code> annotation is needed is that the component function code is executed inside a hermetic container.
The text file needs to somehow be placed inside the container.
Only the system can do that.
The <code>text_path: InputPath()</code> annotation tells the system that the input data for the <code>text</code> input should be placed into some file and the path of that file should be given to the function as a value for the <code>text_path</code> function parameter.</p>
<p>Similarly the <code>filtered_text_path: OutputPath()</code> parameter annotation is needed so that the system knows that it needs to get the output data out of the container when the function finishes its execution.</p>
<h3 id="default-parameter-values">Default parameter values</h3>
<p>The <code>create_component_from_func</code> function supports functions with default parameter values.
This results in the generated component inputs becoming optional.</p>
<p>Path parameters annotated with <code>InputPath()</code> can have a default value of <code>None</code> which makes those file inputs optional.</p>
<p>The default parameter values can use any Python built-in type.
(Only the built-in types can be used because the function needs to remain self-contained).</p>
<pre><code class="language-python">def some_func(
    some_int: int = 3,
    some_path: InputPath() = None,
):
    from pathlib import Path
    if some_path:
        Path(some_path).read_text()
    ...
</code></pre>
<!-- TODO: Directories -->

<!-- TODO: Multiple outputs -->

<h3 id="mapping-function-parameters-to-inputs-and-outputs">Mapping function parameters to inputs and outputs</h3>
<p>The function parameters (the parameter names and type annotations) are mapped to component inputs and outputs in a certain way.</p>
<p>This example demonstrates all aspects of the mapping</p>
<pre><code class="language-python">def my_func(
    # Directly supported types:
    # Mapped to input with name &quot;some_string&quot; and type &quot;String&quot;
    some_string: str,
    # Mapped to input with name &quot;some_string&quot; and type &quot;Integer&quot;
    some_integer: int,
    # Mapped to input with name &quot;some_float&quot; and type &quot;Float&quot;
    some_float: float,
    # Mapped to input with name &quot;some_boolean&quot; and type &quot;Boolean&quot;
    some_boolean: bool,
    # Mapped to input with name &quot;some_list&quot; and type &quot;JsonArray&quot;
    some_list: list,
    # Mapped to input with name &quot;some_dict&quot; and type &quot;JsonObject&quot;
    some_dict: dict,

    # Mapped to input with name &quot;any_thing&quot; and no type (compatible with any type. Will receive a string value at runtime!)
    any_thing,

    # Other types
    # Mapped to input with name &quot;some_uri&quot; and type &quot;Uri&quot; (Will receive a string value at runtime!)
    some_uri: &quot;Uri&quot;,
    # Mapped to input with name &quot;some_uri&quot; and type &quot;BigInt&quot; (Will receive a string value at runtime!)
    some_uri: BigInt,

    # Paths:
    # Mapped to input with name &quot;input1&quot; (the &quot;_path&quot; suffix is removed)
    input1_path: InputPath(&quot;&quot;),
    # Mapped to output with name &quot;output1&quot; and type &quot;CSV&quot; (the &quot;_path&quot; suffix is removed)
    output1_path: OutputPath(&quot;CSV&quot;),
) -&gt; typing.NamedTuple(&quot;Outputs&quot;, [
    # Mapped to output with name &quot;output_string&quot; and type &quot;String&quot;
    (&quot;output_string&quot;, str),
    # Mapped to output with name &quot;output_uri&quot; and type &quot;Uri&quot; (function needs to return a string)
    (&quot;output_uri&quot;, &quot;Uri&quot;),
]):
    ...
    return (&quot;Some string&quot;, &quot;some-uri://...&quot;)
</code></pre>
<h3 id="supported-types">Supported types</h3>
<p>The <code>create_component_from_func</code> function supports functions with any type annotations (including arbitrary type name annotations).
However only a few basic Python types are handled in a special way where the SDK supports automatic data serialization and deserialization.</p>
<p>The full list of directly supported basic Python types is: <code>str</code>, <code>int</code>, <code>float</code>, <code>bool</code>, <code>list</code>, <code>dict</code>.
Plus the special annotations for input and output paths: <code>InputPath(...)</code> and <code>OutputPath(...)</code>.
All other types can still be used, but they are not automatically deserialized, so the Python component function code receives the parameter values as strings.
For example, with the <code>param1: BigInt</code> or <code>param1: "BigInt"</code> parameter type annotation, the function will receive a plain <code>str</code> object.</p>
<h3 id="advanced-component-configuration">Advanced component configuration</h3>
<h4 id="python-packages">Python packages</h4>
<p>A Python component can dynamically install Python packages before running the component function.
To specify the packages, use the <code>packages_to_install</code> parameter of the <code>create_component_from_func</code> function:
<code>create_component_from_func(..., packages_to_install=["pandas==1.14.0"])</code>.
Each item follows the <code>pip install</code> syntax.</p>
<h4 id="base-container-image">Base container image</h4>
<p>All container components are executed inside a Docker container.
By default the official <code>python</code> container image is used.
To explicitly specify the container image, use the <code>base_image</code> parameter of the <code>create_component_from_func</code> function: <code>create_component_from_func(..., base_image="tensorflow/tensorflow:2.8")</code>.
Choose a container image that has all or most of the Python packages that you need, to reduce the startup time and the number of packages that need to be dynamically installed using <code>packages_to_install</code>.</p>
<pre><code class="language-python">filter_text_op = create_component_from_func(
    func=filter_text,
    output_component_file=&quot;component.yaml&quot;,
    base_image=&quot;tensorflow/tensorflow:2.8&quot;,
    packages_to_install=[&quot;pandas==1.14.0&quot;],
)
</code></pre>
<!-- TODO: annotations -->

<h3 id="rules">Rules</h3>
<h4 id="the-function-must-be-standalone-self-contained">The function must be standalone (self-contained)</h4>
<p>The function source code is copied to the generated component.
Any code outside of the function definition will be left out.
So the function must be self-contained.</p>
<p>The function should import all modules inside the function body.
The function can only call functions and use classes from the imported modules.
For example, the component function cannot call a sibling function.
Fortunately, in Python any code can be placed inside a function: imports, other functions, classes:</p>
<pre><code class="language-python">def my_func():
    import helper_module

    def inner_func():
        ...

    class InnerClass:
        ...

    helper_module.foo()
    inner_func()
    obj = InnerClass()
</code></pre>
<h3 id="component-guidelines">Component guidelines</h3>
<h4 id="components-should-be-pure">Components should be "pure"</h4>
<p>The output of a component should only depend on the input values passed to the component.</p>
<h4 id="avoid-readingchanging-mutable-external-global-state">Avoid reading/changing mutable external global state</h4>
<p>Such components are not pure and have complicated interdependencies and race condition issues that the system cannot know about.</p>
<p>As an example, <strong>avoid</strong> components like this:
<code>Change object in some external system</code>
<code>Delete object in some external system</code></p>
<p>A <code>Create object in some external system</code> component is OK as long as the resulting object is immutable (does not change in the future).</p>
<h4 id="component-name-should-start-with-a-verb">Component name should start with a verb</h4>
<p>Components are function, operations, transformations.
Component names are easier to understand when they start with a verb instead of being a noun.
Example: <code>train_model</code> instead of <code>trainer</code>.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
